<!doctype html><html lang=en><head><title>Transactions Isolation #1: Dirty Read</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=description content><link rel=stylesheet href=../../../css/theme.min.css><script async src="https://www.googletagmanager.com/gtag/js?id=G-1LHXLEKFK2"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-1LHXLEKFK2",{anonymize_ip:!1})}</script></head><body><div id=content class=mx-auto><header class="container mt-sm-5 mt-4 mb-4 mt-xs-1"><div class=row><div class="col-sm-4 col-12 text-sm-right text-center pt-sm-4"><a href=../../../ class=text-decoration-none><img id=home-image class=rounded-circle src=../../../logo.jpeg></a></div><div class="col-sm-8 col-12 text-sm-left text-center"><h2 class="m-0 mb-2 mt-4"><a href=../../../ class=text-decoration-none>Shmulik Klein</a></h2><p class="text-muted mb-1">Software Engineer | Munich, Germany</p><ul id=nav-links class="list-inline mb-2"><li class=list-inline-item><a class="badge badge-white" href=../../../about/ title=About>About</a></li><li class=list-inline-item><a class="badge badge-white" href=../../../posts/ title=Posts>Posts</a></li><li class=list-inline-item><a class="badge badge-white" href=../../../tags/ title=Tags>Tags</a></li><li class=list-inline-item><a class="badge badge-white" href=../../../categories/ title=Categories>Categories</a></li><li class=list-inline-item><a class="badge badge-white" href=../../../series/ title=Series>Series</a></li></ul><ul id=nav-social class=list-inline><li class="list-inline-item mr-3"><a href=http://github.com/shmulik-klein target=_blank><i class="fab fa-github fa-1x text-muted"></i></a></li><li class="list-inline-item mr-3"><a href="https://www.linkedin.com/in/shmulik-klein/?lipi=urn%3Ali%3Apage%3Ad_flagship3_feed%3BuBzQ49WXS3K1iGjTur%2Fycw%3D%3D" target=_blank><i class="fab fa-linkedin-in fa-1x text-muted"></i></a></li><li class="list-inline-item mr-3"><a href=https://stackoverflow.com/users/2776473/shmulik-klein target=_blank><i class="fab fab fa-stack-overflow text-muted"></i></a></li><li class="list-inline-item mr-3"><a href=https://twitter.com/klein_sh target=_blank><i class="fab fa-twitter fa-1x text-muted"></i></a></li><li class="list-inline-item mr-3"><a href=mailto:shmulik-klein@gmail.com target=_blank><i class="fas fa-at fa-1x text-muted"></i></a></li></ul></div></div><hr></header><div class=container><div class="pl-sm-4 ml-sm-5"><p><em>Transaction</em> is an atomic unit of work, sometimes made up of multiple operations.</p><p>When a transaction makes multiple changes to the database, either all the changes succeed when the transaction is <em>committed</em>, or all the changes are undone when the transaction is <em>rolled-back</em>.</p><h3 id=transactions-dont-socialize>Transactions don&rsquo;t socialize</h3><p><em>Isolation</em> is the &lsquo;I&rsquo; in ACID (a set of properties of a database transactions intend to guarantee data validity)
It ensures that concurrent execution of transactions will obtain the same state that would have been obtained if the transactions were executed sequentially.</p><p>When executing transactions, we can choose differnt levels of isolation, which sets the tradeoff between performance and reliability.</p><p>To set an isolation level for a transaction we pass <code>sql.TxOptions</code> with the desired isolation level:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>...</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>tx</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>BeginTx</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>(), <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>sql</span>.<span style=color:#a6e22e>TxOptions</span>{<span style=color:#a6e22e>Isolation</span>: <span style=color:#a6e22e>sql</span>.<span style=color:#a6e22e>LevelReadUncommitted</span>})
</span></span><span style=display:flex><span><span style=color:#f92672>...</span>
</span></span></code></pre></div><p>In the following series of blogs I would like to introduce the different isolation level together with their tradeoffs.</p><p>Lets use the following <code>users</code> table for the next examples:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> <span style=color:#f92672>`</span>users<span style=color:#f92672>`</span> (
</span></span><span style=display:flex><span>  <span style=color:#f92672>`</span>id<span style=color:#f92672>`</span> int <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span> AUTO_INCREMENT,
</span></span><span style=display:flex><span>  <span style=color:#f92672>`</span>name<span style=color:#f92672>`</span> varchar(<span style=color:#ae81ff>30</span>) <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>`</span>balance<span style=color:#f92672>`</span> int <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span> <span style=color:#66d9ef>DEFAULT</span> <span style=color:#e6db74>&#39;0&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>PRIMARY</span> <span style=color:#66d9ef>KEY</span> (<span style=color:#f92672>`</span>id<span style=color:#f92672>`</span>)
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>INTO</span> users(name, balance) <span style=color:#66d9ef>values</span> (<span style=color:#e6db74>&#34;Bert&#34;</span>, <span style=color:#ae81ff>100</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>INTO</span> users(name, balance) <span style=color:#66d9ef>values</span> (<span style=color:#e6db74>&#34;Ernie&#34;</span>, <span style=color:#ae81ff>100</span>);
</span></span></code></pre></div><h3 id=reading-gets-dirty>Reading Gets Dirty</h3><p>When using the least isolated level - <code>READ_UNCOMITTED</code> - one transacation can see another transaction&rsquo;s uncommited changes.
Such phenomena has a name. It is called a <em>Dirty Read</em>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>db</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>sql</span>.<span style=color:#a6e22e>Open</span>(<span style=color:#e6db74>&#34;mysql&#34;</span>, <span style=color:#e6db74>&#34;user:pass@tcp(127.0.0.1:3306)/my_db&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatalln</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>Close</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ctx1</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>tx1</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>BeginTx</span>(<span style=color:#a6e22e>ctx1</span>, <span style=color:#66d9ef>nil</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatalln</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>tx1</span>.<span style=color:#a6e22e>ExecContext</span>(<span style=color:#a6e22e>ctx1</span>, <span style=color:#e6db74>&#34;UPDATE users SET amount = 50 WHERE name = &#39;Bert&#39;&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatalln</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>tx1</span>.<span style=color:#a6e22e>Rollback</span>()
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>go</span> <span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>ctx2</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>()
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>tx2</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>BeginTx</span>(<span style=color:#a6e22e>ctx2</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>sql</span>.<span style=color:#a6e22e>TxOptions</span>{<span style=color:#a6e22e>Isolation</span>: <span style=color:#a6e22e>sql</span>.<span style=color:#a6e22e>LevelReadUncommitted</span>})
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatalln</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>tx2</span>.<span style=color:#a6e22e>Rollback</span>()
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>r</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>tx2</span>.<span style=color:#a6e22e>Query</span>(<span style=color:#e6db74>&#34;SELECT amount FROM users WHERE id = 1&#34;</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatalln</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>tx2</span>.<span style=color:#a6e22e>Rollback</span>()
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Close</span>()
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>amount</span> <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Next</span>() {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Scan</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>amount</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;TX2: Bert has a balance of %d€\n&#34;</span>, <span style=color:#a6e22e>amount</span>)
</span></span><span style=display:flex><span>	}()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#ae81ff>1</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>tx1</span>.<span style=color:#a6e22e>Rollback</span>()
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></div></div></div><footer class="text-center pb-1"><small class=text-muted>&copy; Copyright 2022, Shmulik Klein<br>Powered by <a href=https://gohugo.io/ target=_blank>Hugo</a>
and <a href=https://github.com/austingebauer/devise target=_blank>Devise</a></small></footer></body></html>